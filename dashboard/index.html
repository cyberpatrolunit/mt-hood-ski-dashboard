<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPU Mac Mini Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .robot {
      font-size: 36px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: transform 0.2s, border-color 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      color: #ffffff;
      opacity: 0.9;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #999;
      font-size: 14px;
    }

    .stat-value {
      color: #fff;
      font-weight: 600;
      font-size: 16px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .model-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .model-btn {
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(50, 50, 50, 0.5);
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .model-btn:hover {
      background: rgba(70, 70, 70, 0.7);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
    }

    .model-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
    }

    .model-price {
      font-size: 11px;
      opacity: 0.7;
    }

    .timestamp {
      text-align: center;
      color: #666;
      font-size: 12px;
      margin-top: 20px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .error {
      color: #f87171;
    }

    .cron-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cron-item {
      padding: 10px;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 6px;
      font-size: 13px;
    }

    .cron-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .cron-schedule {
      color: #999;
      font-size: 11px;
    }

    /* Roaming Squirrel Styles */
    .squirrel {
      position: fixed;
      font-size: 3.5rem;
      cursor: pointer;
      z-index: 9999;
      pointer-events: auto;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      transition: transform 0.15s ease;
      user-select: none;
    }

    .squirrel:hover {
      transform: scale(1.3) !important;
      filter: drop-shadow(0 4px 8px rgba(255, 255, 255, 0.4));
    }

    .squirrel::after {
      content: 'Click for surprise! üéâ';
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.4rem;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    .squirrel:hover::after {
      transform: translateX(-50%) scale(1);
      opacity: 1;
    }

    .paw-print {
      position: fixed;
      font-size: 1.2rem;
      opacity: 0.4;
      z-index: 9998;
      pointer-events: none;
      animation: fadePaw 3s ease-out forwards;
    }

    @keyframes fadePaw {
      0% { opacity: 0.4; }
      100% { opacity: 0; transform: scale(0.5); }
    }

    @keyframes scurry {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(-2deg); }
      50% { transform: translateY(0) rotate(0deg); }
      75% { transform: translateY(-6px) rotate(2deg); }
    }

    @keyframes lookAround {
      0%, 100% { transform: scale(1) rotate(0deg); }
      20% { transform: scale(1.1) rotate(-10deg); }
      40% { transform: scale(1.1) rotate(10deg); }
      60% { transform: scale(1.1) rotate(-5deg); }
      80% { transform: scale(1.1) rotate(5deg); }
    }

    /* Blizzard Mode */
    .blizzard-active {
      pointer-events: none;
    }

    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 1.5rem;
      z-index: 10000;
      animation: fall linear infinite;
      opacity: 0.8;
      pointer-events: none;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    .splash-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 60px;
      border-radius: 20px;
      font-size: 2.5rem;
      font-weight: bold;
      z-index: 10001;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: splashPop 0.5s ease-out forwards;
    }

    @keyframes splashPop {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-10deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .squirrel {
        font-size: 2.5rem;
      }
      .paw-print {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span class="robot">ü§ñ</span>
      <span>CPU Mac Mini</span>
      <span class="status-dot"></span>
    </h1>

    <div class="grid">
      <!-- System Stats -->
      <div class="card">
        <h2>System Resources</h2>
        <div class="stat">
          <span class="stat-label">CPU Usage</span>
          <span class="stat-value" id="cpu-usage">--</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="cpu-progress"></div>
        </div>
        
        <div class="stat">
          <span class="stat-label">Memory</span>
          <span class="stat-value" id="memory-usage">--</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="memory-progress"></div>
        </div>
        
        <div class="stat">
          <span class="stat-label">Disk Usage</span>
          <span class="stat-value" id="disk-usage">--</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="disk-progress"></div>
        </div>
      </div>

      <!-- System Info -->
      <div class="card">
        <h2>System Info</h2>
        <div class="stat">
          <span class="stat-label">Uptime</span>
          <span class="stat-value" id="uptime">--</span>
        </div>
        <div class="stat">
          <span class="stat-label">Processes</span>
          <span class="stat-value" id="processes">--</span>
        </div>
        <div class="stat">
          <span class="stat-label">Network (RX)</span>
          <span class="stat-value" id="network">--</span>
        </div>
      </div>

      <!-- OpenClaw Session -->
      <div class="card">
        <h2>OpenClaw Session</h2>
        <div class="stat">
          <span class="stat-label">Current Model</span>
          <span class="stat-value" id="current-model">--</span>
        </div>
        <div class="stat">
          <span class="stat-label">Tokens Used</span>
          <span class="stat-value" id="tokens">--</span>
        </div>
        <div class="stat">
          <span class="stat-label">Session Age</span>
          <span class="stat-value" id="session-age">--</span>
        </div>
      </div>

      <!-- Model Switcher -->
      <div class="card">
        <h2>Quick Model Switch</h2>
        <div class="model-buttons">
          <button class="model-btn" onclick="switchModel('haiku', this)">
            <span>Haiku</span>
            <span class="model-price">~$0.25/1M</span>
          </button>
          <button class="model-btn active" onclick="switchModel('sonnet', this)">
            <span>Sonnet</span>
            <span class="model-price">~$3/1M</span>
          </button>
          <button class="model-btn" onclick="switchModel('opus', this)">
            <span>Opus</span>
            <span class="model-price">~$15/1M</span>
          </button>
          <button class="model-btn" onclick="switchModel('qwen', this)">
            <span>Qwen (Local)</span>
            <span class="model-price">Free</span>
          </button>
        </div>
      </div>

      <!-- Scheduled Tasks -->
      <div class="card">
        <h2>Scheduled Tasks</h2>
        <div class="cron-list" id="cron-list">
          <div class="cron-item">Loading...</div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <h2>Quick Links</h2>
        <div class="stat">
          <span class="stat-label">Gateway Dashboard</span>
          <a href="http://192.168.1.36:18789/" target="_blank" style="color: #4facfe; text-decoration: none;">Open ‚Üí</a>
        </div>
        <div class="stat">
          <span class="stat-label">Documentation</span>
          <a href="https://docs.openclaw.ai" target="_blank" style="color: #4facfe; text-decoration: none;">Open ‚Üí</a>
        </div>
      </div>
    </div>

    <div class="timestamp" id="last-update">Last updated: --</div>
  </div>

  <script>
    let currentModel = 'sonnet';

    async function fetchStats() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        // CPU
        const cpuTotal = data.cpu.user + data.cpu.system;
        document.getElementById('cpu-usage').textContent = `${cpuTotal.toFixed(1)}%`;
        const cpuProgress = document.getElementById('cpu-progress');
        cpuProgress.style.width = `${cpuTotal}%`;
        cpuProgress.className = cpuTotal > 80 ? 'progress-fill warning' : 'progress-fill';
        
        // Memory - parse "free:" value
        const memFree = parseFloat(data.memory.free || '0');
        const memActive = parseFloat(data.memory.active || '0');
        const memTotal = memFree + memActive;
        const memPercent = memTotal > 0 ? ((memActive / memTotal) * 100) : 0;
        document.getElementById('memory-usage').textContent = `${memActive.toFixed(1)} GB / ${memTotal.toFixed(1)} GB`;
        const memProgress = document.getElementById('memory-progress');
        memProgress.style.width = `${memPercent}%`;
        memProgress.className = memPercent > 80 ? 'progress-fill warning' : 'progress-fill';
        
        // Disk
        document.getElementById('disk-usage').textContent = `${data.disk.used} / ${data.disk.available}`;
        const diskProgress = document.getElementById('disk-progress');
        const diskPercent = parseFloat(data.disk.percent);
        diskProgress.style.width = data.disk.percent;
        diskProgress.className = diskPercent > 80 ? 'progress-fill warning' : 'progress-fill';
        
        // System info
        document.getElementById('uptime').textContent = data.uptime.split('load')[0].trim();
        document.getElementById('processes').textContent = data.processes;
        document.getElementById('network').textContent = data.network;
        
        document.getElementById('last-update').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (error) {
        console.error('Error fetching stats:', error);
      }
    }

    async function fetchOpenClaw() {
      try {
        const response = await fetch('/api/openclaw');
        const data = await response.json();
        
        document.getElementById('current-model').textContent = data.model;
        document.getElementById('tokens').textContent = data.tokens ? 
          `${data.tokens.toLocaleString()} (${data.tokensUsed}%)` : '--';
        document.getElementById('session-age').textContent = data.age;
      } catch (error) {
        console.error('Error fetching OpenClaw data:', error);
        document.getElementById('current-model').textContent = 'Error';
        document.getElementById('tokens').textContent = '--';
        document.getElementById('session-age').textContent = '--';
      }
    }

    async function fetchCron() {
      try {
        const response = await fetch('/api/cron');
        const data = await response.json();
        
        const cronList = document.getElementById('cron-list');
        if (data.jobs && data.jobs.length > 0) {
          cronList.innerHTML = data.jobs.slice(0, 5).map(job => `
            <div class="cron-item">
              <div class="cron-name">${job.name || 'Unnamed Task'}</div>
              <div class="cron-schedule">${job.schedule?.expr || job.schedule?.kind || 'Unknown schedule'}</div>
            </div>
          `).join('');
        } else {
          cronList.innerHTML = '<div class="cron-item">No scheduled tasks</div>';
        }
      } catch (error) {
        console.error('Error fetching cron jobs:', error);
      }
    }

    async function switchModel(model, btnElement) {
      try {
        const response = await fetch('/api/model/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model })
        });
        
        const data = await response.json();
        if (data.success) {
          currentModel = model;
          document.querySelectorAll('.model-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          btnElement.classList.add('active');
          
          // Show quick confirmation
          const originalText = btnElement.innerHTML;
          btnElement.innerHTML = '<span>‚úì Switched</span>';
          setTimeout(() => {
            btnElement.innerHTML = originalText;
          }, 2000);
          
          // Refresh stats
          fetchOpenClaw();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error switching model:', error);
        alert('Error switching model: ' + error.message);
      }
    }

    // Initial fetch
    fetchStats();
    fetchOpenClaw();
    fetchCron();

    // Auto-refresh every 5 seconds
    setInterval(fetchStats, 5000);
    setInterval(fetchOpenClaw, 10000);
    setInterval(fetchCron, 30000);

    // ===== ROAMING SQUIRREL SYSTEM =====
    
    class SquirrelManager {
      constructor() {
        this.activeSquirrels = [];
        this.maxSquirrels = 3;
        this.blizzardActive = false;
        this.scheduleNextSquirrel();
      }

      scheduleNextSquirrel() {
        // Random interval between 30-120 seconds
        const delay = 30000 + Math.random() * 90000;
        setTimeout(() => {
          this.spawnSquirrel();
          this.scheduleNextSquirrel();
        }, delay);
      }

      spawnSquirrel() {
        if (this.activeSquirrels.length >= this.maxSquirrels) return;

        // Random chance for multiple squirrels (10% chance for 2, 2% for 3)
        const multiCount = Math.random() < 0.02 ? 3 : Math.random() < 0.1 ? 2 : 1;
        
        for (let i = 0; i < multiCount; i++) {
          setTimeout(() => this.createSquirrel(), i * 500);
        }
      }

      createSquirrel() {
        const squirrel = document.createElement('div');
        squirrel.className = 'squirrel';
        squirrel.textContent = 'üêøÔ∏è';
        
        // Random starting side (true = left, false = right)
        const fromLeft = Math.random() > 0.5;
        
        // Random vertical position (avoid very top and bottom)
        const topPercent = 10 + Math.random() * 70;
        
        // Starting position
        squirrel.style.top = `${topPercent}%`;
        squirrel.style.left = fromLeft ? '-100px' : `${window.innerWidth}px`;
        
        // Flip squirrel to face direction
        squirrel.style.transform = fromLeft ? 'scaleX(1)' : 'scaleX(-1)';
        
        document.body.appendChild(squirrel);
        this.activeSquirrels.push(squirrel);

        // Random speed (2-6 seconds to cross screen)
        const duration = 2000 + Math.random() * 4000;
        
        // Add bouncy scurry animation
        squirrel.style.animation = `scurry 0.3s ease-in-out infinite`;
        
        // Click handler for Easter egg
        squirrel.addEventListener('click', (e) => {
          e.stopPropagation();
          this.triggerEasterEgg(squirrel);
        });

        // Animate across screen
        this.animateSquirrel(squirrel, fromLeft, duration);
      }

      animateSquirrel(squirrel, fromLeft, duration) {
        const startTime = Date.now();
        const startX = fromLeft ? -100 : window.innerWidth;
        const endX = fromLeft ? window.innerWidth + 100 : -100;
        const totalDistance = Math.abs(endX - startX);
        
        let pauseTime = null;
        let pauseDuration = 0;
        
        // Random pause between 30-70% of journey
        const pauseAt = 0.3 + Math.random() * 0.4;
        
        const animate = () => {
          const elapsed = Date.now() - startTime - pauseDuration;
          const progress = Math.min(elapsed / duration, 1);
          
          // Pause to "look around"
          if (progress > pauseAt && progress < pauseAt + 0.1 && !pauseTime) {
            pauseTime = Date.now();
            squirrel.style.animation = 'lookAround 1s ease-in-out';
            setTimeout(() => {
              pauseDuration = Date.now() - pauseTime;
              pauseTime = null;
              squirrel.style.animation = 'scurry 0.3s ease-in-out infinite';
            }, 1000);
            requestAnimationFrame(animate);
            return;
          }
          
          // Smooth easing
          const eased = progress < 0.5
            ? 2 * progress * progress
            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
          
          const currentX = startX + (endX - startX) * eased;
          squirrel.style.left = `${currentX}px`;
          
          // Leave paw prints occasionally
          if (Math.random() < 0.05 && progress > 0.1 && progress < 0.9) {
            this.createPawPrint(currentX, squirrel.style.top);
          }
          
          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            this.removeSquirrel(squirrel);
          }
        };
        
        requestAnimationFrame(animate);
      }

      createPawPrint(x, top) {
        const paw = document.createElement('div');
        paw.className = 'paw-print';
        paw.textContent = 'üêæ';
        paw.style.left = `${x}px`;
        paw.style.top = top;
        document.body.appendChild(paw);
        
        setTimeout(() => paw.remove(), 3000);
      }

      removeSquirrel(squirrel) {
        const index = this.activeSquirrels.indexOf(squirrel);
        if (index > -1) {
          this.activeSquirrels.splice(index, 1);
        }
        squirrel.remove();
      }

      triggerEasterEgg(clickedSquirrel) {
        if (this.blizzardActive) return;
        
        this.blizzardActive = true;
        
        // Remove all squirrels
        this.activeSquirrels.forEach(sq => sq.remove());
        this.activeSquirrels = [];
        
        // Show splash message
        const splash = document.createElement('div');
        splash.className = 'splash-message';
        splash.textContent = 'üêøÔ∏è SQUIRREL SURPRISE! ‚ùÑÔ∏è';
        document.body.appendChild(splash);
        
        // Start blizzard
        this.startBlizzard();
        
        // Remove splash after 2 seconds
        setTimeout(() => splash.remove(), 2000);
        
        // Stop blizzard after 8 seconds
        setTimeout(() => {
          this.blizzardActive = false;
          document.querySelectorAll('.snowflake').forEach(sf => sf.remove());
        }, 8000);
      }

      startBlizzard() {
        const emojis = ['‚ùÑÔ∏è', '‚õÑ', 'üêøÔ∏è', 'üå®Ô∏è', '‚ú®'];
        const flakeCount = 50;
        
        for (let i = 0; i < flakeCount; i++) {
          setTimeout(() => {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            flake.style.left = `${Math.random() * 100}%`;
            flake.style.fontSize = `${0.8 + Math.random() * 1.5}rem`;
            flake.style.animationDuration = `${3 + Math.random() * 4}s`;
            flake.style.animationDelay = `${Math.random() * 2}s`;
            document.body.appendChild(flake);
            
            setTimeout(() => flake.remove(), 10000);
          }, i * 100);
        }
      }
    }

    // Initialize squirrel system
    const squirrelManager = new SquirrelManager();
    
    // Spawn first squirrel after 5-10 seconds
    setTimeout(() => squirrelManager.spawnSquirrel(), 5000 + Math.random() * 5000);

    // ===== HIDDEN MIDI PLAYER =====
    
    class MIDIPlayer {
      constructor() {
        this.tracks = [
          '/midi/shake_it_off.mid',
          '/midi/love_story.mid',
          '/midi/blank_space.mid'
        ];
        this.synth = null;
        this.currentPart = null;
        this.init();
      }

      async init() {
        // Wait for Tone.js to be ready
        await Tone.start();
        
        // Create a polyphonic synth
        this.synth = new Tone.PolySynth(Tone.Synth, {
          volume: -3,
          oscillator: { type: 'triangle' },
          envelope: {
            attack: 0.005,
            decay: 0.1,
            sustain: 0.3,
            release: 1
          }
        }).toDestination();
        
        // Start playing after a short delay
        setTimeout(() => this.playRandom(), 2000);
      }

      async playRandom() {
        // Pick random track
        const randomTrack = this.tracks[Math.floor(Math.random() * this.tracks.length)];

        try {
          // Fetch and parse MIDI
          const midi = await Midi.fromUrl(randomTrack);
          
          // Clear previous part if exists
          if (this.currentPart) {
            this.currentPart.dispose();
          }
          
          // Get the first track with notes
          const track = midi.tracks.find(t => t.notes.length > 0);
          if (!track) {
            console.log('No notes in MIDI, trying next track');
            setTimeout(() => this.playRandom(), 5000);
            return;
          }
          
          // Create a Part from the notes
          this.currentPart = new Tone.Part((time, note) => {
            this.synth.triggerAttackRelease(
              note.name,
              note.duration,
              time,
              note.velocity
            );
          }, track.notes.map(note => ({
            time: note.time,
            name: note.name,
            duration: note.duration,
            velocity: note.velocity
          })));
          
          // Start the part
          this.currentPart.start(0);
          
          // Schedule next track after this one finishes
          const duration = track.duration;
          Tone.Transport.schedule(() => {
            this.currentPart.dispose();
            this.playRandom();
          }, duration + 2);
          
          // Start transport if not already started
          if (Tone.Transport.state !== 'started') {
            Tone.Transport.start();
          }
          
        } catch (error) {
          console.log('MIDI player error, trying next track in 30s:', error.message);
          setTimeout(() => this.playRandom(), 30000);
        }
      }
    }

    // Initialize hidden MIDI player
    const midiPlayer = new MIDIPlayer();
  </script>
</body>
</html>
